<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Correction Validation Modification</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        button { 
            background: #2196f3; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px 5px;
        }
        button:hover { background: #1976d2; }
        button.success { background: #4caf50; }
        button.error { background: #f44336; }
        button.warning { background: #ff9800; }
        .result { 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test - Correction Validation Modification</h1>
        <p><strong>Objectif :</strong> Vérifier que les problèmes d'unicité en modification sont résolus.</p>

        <div class="test-section">
            <h2>Étape 1: Créer une candidature de test</h2>
            <button onclick="createTestApplication()">Créer candidature test</button>
            <div id="createResult"></div>
        </div>

        <div class="test-section">
            <h2>Étape 2: Modifier la candidature créée</h2>
            <p>Application ID: <input type="number" id="applicationId" placeholder="ID de l'application" style="width: 100px;"></p>
            
            <h3>Test des modifications problématiques:</h3>
            <button onclick="testUpdateSameData()" class="warning">Modifier avec mêmes données (doit réussir)</button>
            <button onclick="testUpdateWithCFE()" class="success">Modifier avec CFE activé</button>
            <button onclick="testUpdateWithNIF()" class="success">Modifier avec NIF activé</button>
            <button onclick="testUpdateWithBoth()" class="success">Modifier avec CFE + NIF</button>
            
            <div id="updateResult"></div>
        </div>

        <div class="test-section">
            <h2>Étape 3: Tests de validation CFE/NIF</h2>
            <button onclick="testCFEValidation()" class="error">Test CFE coché sans données (doit échouer)</button>
            <button onclick="testNIFValidation()" class="error">Test NIF coché sans données (doit échouer)</button>
            
            <div id="validationResult"></div>
        </div>
    </div>

    <script>
        let testApplicationId = null;

        async function createTestApplication() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = 'Création en cours...';
            resultDiv.className = 'result info';

            // Générer des données uniques pour éviter les conflits
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(7);

            const formData = new FormData();
            
            // Données de base
            formData.append('first_name', `Test${timestamp}`);
            formData.append('last_name', `User${randomStr}`);
            formData.append('birth_date', '1990-01-01');
            formData.append('birth_place', 'Test City');
            formData.append('gender', 'M');
            formData.append('nationality', 'Test Nationality');
            formData.append('phone', `+226${timestamp.toString().slice(-8)}`);
            formData.append('merchant_phone', `+226${(timestamp + 1).toString().slice(-8)}`);
            formData.append('email', `test${timestamp}@example.com`);
            formData.append('address', 'Test Address ' + randomStr);
            
            // Documents d'identité
            formData.append('id_type', 'cni');
            formData.append('id_number', `CNI${timestamp}`);
            formData.append('id_expiry_date', '2030-12-31');
            
            // Informations commerciales
            formData.append('business_name', `Test Business ${randomStr}`);
            formData.append('business_type', 'boutique');
            formData.append('business_address', 'Test Business Address');
            formData.append('usage_type', 'TRADER');
            
            // CFE et NIF (non cochés initialement)
            formData.append('has_cfe', 'false');
            formData.append('has_nif', 'false');
            
            // Signature et acceptation
            formData.append('signature', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==');
            formData.append('accept_terms', 'true');

            try {
                const response = await axios.post('http://localhost:8000/api/merchant-applications', formData, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'multipart/form-data'
                    }
                });

                testApplicationId = response.data.data.id;
                document.getElementById('applicationId').value = testApplicationId;

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ CANDIDATURE CRÉÉE AVEC SUCCÈS\n\nID: ${testApplicationId}\nRéférence: ${response.data.data.reference_number}\nTéléphone: ${formData.get('phone')}\nEmail: ${formData.get('email')}\nID Number: ${formData.get('id_number')}\n\nMaintenant vous pouvez tester les modifications.`;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ ERREUR CRÉATION\n\nCode: ${error.response?.status}\nMessage: ${error.message}\nDétails: ${JSON.stringify(error.response?.data, null, 2)}`;
            }
        }

        async function testUpdateSameData() {
            const appId = document.getElementById('applicationId').value;
            if (!appId) {
                alert('Veuillez d\'abord créer une candidature ou saisir un ID');
                return;
            }

            await testUpdate(appId, {
                description: 'Modification avec les mêmes données (test unicité)',
                changes: {
                    // Pas de changement des données sensibles, juste business_address
                    business_address: 'Nouvelle adresse business ' + Date.now()
                }
            });
        }

        async function testUpdateWithCFE() {
            const appId = document.getElementById('applicationId').value;
            if (!appId) {
                alert('Veuillez d\'abord créer une candidature ou saisir un ID');
                return;
            }

            await testUpdate(appId, {
                description: 'Activation CFE avec numéro et date',
                changes: {
                    has_cfe: true,
                    cfe_number: 'CFE' + Date.now(),
                    cfe_expiry_date: '2030-12-31'
                }
            });
        }

        async function testUpdateWithNIF() {
            const appId = document.getElementById('applicationId').value;
            if (!appId) {
                alert('Veuillez d\'abord créer une candidature ou saisir un ID');
                return;
            }

            await testUpdate(appId, {
                description: 'Activation NIF avec numéro',
                changes: {
                    has_nif: true,
                    nif_number: 'NIF' + Date.now()
                }
            });
        }

        async function testUpdateWithBoth() {
            const appId = document.getElementById('applicationId').value;
            if (!appId) {
                alert('Veuillez d\'abord créer une candidature ou saisir un ID');
                return;
            }

            await testUpdate(appId, {
                description: 'Activation CFE + NIF',
                changes: {
                    has_cfe: true,
                    cfe_number: 'CFE' + Date.now(),
                    cfe_expiry_date: '2030-12-31',
                    has_nif: true,
                    nif_number: 'NIF' + Date.now()
                }
            });
        }

        async function testUpdate(appId, testConfig) {
            const resultDiv = document.getElementById('updateResult');
            resultDiv.innerHTML = `Test en cours: ${testConfig.description}...`;
            resultDiv.className = 'result info';

            try {
                // D'abord récupérer les données actuelles
                const currentResponse = await axios.get(`http://localhost:8000/api/merchant-applications/${appId}`, {
                    headers: { 'Accept': 'application/json' }
                });

                const currentData = currentResponse.data.data;
                
                // Préparer les données de mise à jour
                const updateData = {
                    first_name: currentData.first_name,
                    last_name: currentData.last_name,
                    birth_date: currentData.birth_date,
                    birth_place: currentData.birth_place,
                    gender: currentData.gender,
                    nationality: currentData.nationality,
                    phone: currentData.phone,
                    merchant_phone: currentData.merchant_phone,
                    email: currentData.email,
                    address: currentData.address,
                    id_type: currentData.id_type,
                    id_number: currentData.id_number,
                    id_expiry_date: currentData.id_expiry_date,
                    business_name: currentData.business_name,
                    business_type: currentData.business_type,
                    business_address: currentData.business_address,
                    usage_type: currentData.usage_type,
                    has_cfe: currentData.has_cfe || false,
                    cfe_number: currentData.cfe_number || '',
                    cfe_expiry_date: currentData.cfe_expiry_date || '',
                    has_nif: currentData.has_nif || false,
                    nif_number: currentData.nif_number || '',
                    signature: currentData.signature || 'data:image/png;base64,test',
                    accept_terms: true,
                    // Appliquer les modifications spécifiques au test
                    ...testConfig.changes
                };

                const response = await axios.put(`http://localhost:8000/api/merchant-applications/${appId}/full`, updateData, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ MODIFICATION RÉUSSIE: ${testConfig.description}\n\nCode: ${response.status}\nModifications appliquées: ${JSON.stringify(testConfig.changes, null, 2)}\n\nRéponse: ${JSON.stringify(response.data.data || response.data, null, 2)}`;

            } catch (error) {
                if (error.response?.status === 422) {
                    const validationErrors = error.response.data.errors;
                    let errorText = '';
                    for (const [field, messages] of Object.entries(validationErrors)) {
                        errorText += `${field}: ${messages.join(', ')}\n`;
                    }
                    
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `❌ ERREUR VALIDATION: ${testConfig.description}\n\nErreurs:\n${errorText}\nModifications tentées: ${JSON.stringify(testConfig.changes, null, 2)}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `❌ ERREUR: ${testConfig.description}\n\nCode: ${error.response?.status}\nMessage: ${error.message}\nDétails: ${JSON.stringify(error.response?.data, null, 2)}`;
                }
            }
        }

        async function testCFEValidation() {
            const appId = document.getElementById('applicationId').value;
            if (!appId) {
                alert('Veuillez d\'abord créer une candidature ou saisir un ID');
                return;
            }

            await testValidationFailure(appId, {
                description: 'CFE coché sans données (doit échouer)',
                changes: {
                    has_cfe: true,
                    cfe_number: '', // Vide intentionnellement
                    cfe_expiry_date: '' // Vide intentionnellement
                },
                expectedErrors: ['cfe_number', 'cfe_expiry_date']
            });
        }

        async function testNIFValidation() {
            const appId = document.getElementById('applicationId').value;
            if (!appId) {
                alert('Veuillez d\'abord créer une candidature ou saisir un ID');
                return;
            }

            await testValidationFailure(appId, {
                description: 'NIF coché sans données (doit échouer)',
                changes: {
                    has_nif: true,
                    nif_number: '' // Vide intentionnellement
                },
                expectedErrors: ['nif_number']
            });
        }

        async function testValidationFailure(appId, testConfig) {
            const resultDiv = document.getElementById('validationResult');
            resultDiv.innerHTML = `Test en cours: ${testConfig.description}...`;
            resultDiv.className = 'result info';

            try {
                // D'abord récupérer les données actuelles
                const currentResponse = await axios.get(`http://localhost:8000/api/merchant-applications/${appId}`, {
                    headers: { 'Accept': 'application/json' }
                });

                const currentData = currentResponse.data.data;
                
                // Préparer les données avec erreur intentionnelle
                const updateData = {
                    first_name: currentData.first_name,
                    last_name: currentData.last_name,
                    birth_date: currentData.birth_date,
                    birth_place: currentData.birth_place,
                    gender: currentData.gender,
                    nationality: currentData.nationality,
                    phone: currentData.phone,
                    merchant_phone: currentData.merchant_phone,
                    email: currentData.email,
                    address: currentData.address,
                    id_type: currentData.id_type,
                    id_number: currentData.id_number,
                    id_expiry_date: currentData.id_expiry_date,
                    business_name: currentData.business_name,
                    business_type: currentData.business_type,
                    business_address: currentData.business_address,
                    usage_type: currentData.usage_type,
                    signature: currentData.signature || 'data:image/png;base64,test',
                    accept_terms: true,
                    // Appliquer les modifications qui doivent échouer
                    ...testConfig.changes
                };

                const response = await axios.put(`http://localhost:8000/api/merchant-applications/${appId}/full`, updateData, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                // Si on arrive ici, c'est que la validation n'a pas échoué comme attendu
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ PROBLÈME: ${testConfig.description}\n\nLe test devait échouer mais a réussi!\nCode: ${response.status}`;

            } catch (error) {
                if (error.response?.status === 422) {
                    const validationErrors = error.response.data.errors;
                    const actualErrors = Object.keys(validationErrors);
                    const expectedErrors = testConfig.expectedErrors;
                    
                    const hasExpectedErrors = expectedErrors.every(field => actualErrors.includes(field));
                    
                    if (hasExpectedErrors) {
                        resultDiv.className = 'result success';
                        resultDiv.innerHTML = `✅ VALIDATION CORRECTE: ${testConfig.description}\n\nErreurs attendues trouvées: ${expectedErrors.join(', ')}\nErreurs reçues: ${JSON.stringify(validationErrors, null, 2)}`;
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.innerHTML = `❌ VALIDATION INCORRECTE: ${testConfig.description}\n\nErreurs attendues: ${expectedErrors.join(', ')}\nErreurs reçues: ${actualErrors.join(', ')}\nDétails: ${JSON.stringify(validationErrors, null, 2)}`;
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `❌ ERREUR INATTENDUE: ${testConfig.description}\n\nCode: ${error.response?.status}\nMessage: ${error.message}`;
                }
            }
        }
    </script>
</body>
</html>