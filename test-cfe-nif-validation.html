<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Validation Conditionnelle CFE/NIF</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .form-group { margin: 15px 0; }
        .checkbox-group { background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 10px 0; }
        input[type="text"], input[type="date"] { 
            padding: 10px; 
            border: 2px solid #ddd; 
            border-radius: 4px; 
            width: 100%; 
            max-width: 300px;
        }
        input.required { border-color: #f44336; }
        input:valid { border-color: #4caf50; }
        input:invalid { border-color: #f44336; }
        label { display: block; margin: 10px 0 5px 0; font-weight: bold; }
        .checkbox-label { font-weight: normal; display: inline; margin-left: 8px; }
        button { 
            background: #2196f3; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px 5px;
        }
        button:hover { background: #1976d2; }
        button.test-btn { background: #ff9800; }
        button.test-btn:hover { background: #f57c00; }
        .result { 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .required-indicator { color: #f44336; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test - Validation Conditionnelle CFE/NIF</h1>
        <p><strong>Objectif :</strong> Vérifier que les champs CFE et NIF deviennent obligatoires quand les cases correspondantes sont cochées.</p>

        <div class="test-section">
            <h2>Formulaire de Test</h2>
            
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="hasCFE" onchange="updateRequiredFields()">
                    <span class="checkbox-label">Je possède une carte CFE</span>
                </label>
                <br><br>
                <label>
                    <input type="checkbox" id="hasNIF" onchange="updateRequiredFields()">
                    <span class="checkbox-label">Je possède un numéro NIF</span>
                </label>
            </div>

            <div class="form-group" id="cfeGroup" style="display: none;">
                <label for="cfeNumber">Numéro CFE <span class="required-indicator">*</span></label>
                <input type="text" id="cfeNumber" placeholder="Numéro CFE">
                
                <label for="cfeExpiryDate">Date d'expiration CFE <span class="required-indicator">*</span></label>
                <input type="date" id="cfeExpiryDate">
            </div>

            <div class="form-group" id="nifGroup" style="display: none;">
                <label for="nifNumber">Numéro NIF <span class="required-indicator">*</span></label>
                <input type="text" id="nifNumber" placeholder="Numéro NIF">
            </div>

            <div class="form-group">
                <button onclick="validateFrontend()" class="test-btn">Tester validation Frontend</button>
                <button onclick="testBackendValidation()">Tester validation Backend</button>
                <button onclick="clearForm()">Réinitialiser</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Scénarios de Test</h2>
            <button onclick="testScenario('cfe-only')">Test CFE uniquement</button>
            <button onclick="testScenario('nif-only')">Test NIF uniquement</button>
            <button onclick="testScenario('both')">Test CFE + NIF</button>
            <button onclick="testScenario('neither')">Test aucun</button>
        </div>

        <div id="results" class="result" style="display: none;"></div>
    </div>

    <script>
        function updateRequiredFields() {
            const hasCFE = document.getElementById('hasCFE').checked;
            const hasNIF = document.getElementById('hasNIF').checked;
            
            // Afficher/masquer les groupes de champs
            document.getElementById('cfeGroup').style.display = hasCFE ? 'block' : 'none';
            document.getElementById('nifGroup').style.display = hasNIF ? 'block' : 'none';
            
            // Mettre à jour les attributs required
            document.getElementById('cfeNumber').required = hasCFE;
            document.getElementById('cfeExpiryDate').required = hasCFE;
            document.getElementById('nifNumber').required = hasNIF;
            
            // Mettre à jour les classes CSS
            document.getElementById('cfeNumber').className = hasCFE ? 'required' : '';
            document.getElementById('cfeExpiryDate').className = hasCFE ? 'required' : '';
            document.getElementById('nifNumber').className = hasNIF ? 'required' : '';
        }

        function validateFrontend() {
            const hasCFE = document.getElementById('hasCFE').checked;
            const hasNIF = document.getElementById('hasNIF').checked;
            const cfeNumber = document.getElementById('cfeNumber').value;
            const cfeExpiryDate = document.getElementById('cfeExpiryDate').value;
            const nifNumber = document.getElementById('nifNumber').value;

            let errors = [];
            
            // Validation CFE
            if (hasCFE) {
                if (!cfeNumber) errors.push('Numéro CFE obligatoire');
                if (!cfeExpiryDate) errors.push('Date d\'expiration CFE obligatoire');
                else if (new Date(cfeExpiryDate) <= new Date()) errors.push('Date d\'expiration CFE invalide (doit être future)');
            }
            
            // Validation NIF
            if (hasNIF) {
                if (!nifNumber) errors.push('Numéro NIF obligatoire');
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            
            if (errors.length === 0) {
                resultsDiv.className = 'result success';
                resultsDiv.innerHTML = `✅ VALIDATION FRONTEND RÉUSSIE\n\nConfiguration:\n- CFE activé: ${hasCFE}\n- NIF activé: ${hasNIF}\n\nValeurs:\n- CFE Number: "${cfeNumber}"\n- CFE Expiry: "${cfeExpiryDate}"\n- NIF Number: "${nifNumber}"\n\nTous les champs requis sont valides!`;
            } else {
                resultsDiv.className = 'result error';
                resultsDiv.innerHTML = `❌ ERREURS DE VALIDATION FRONTEND\n\n${errors.join('\n')}`;
            }
        }

        async function testBackendValidation() {
            const hasCFE = document.getElementById('hasCFE').checked;
            const hasNIF = document.getElementById('hasNIF').checked;
            const cfeNumber = document.getElementById('cfeNumber').value;
            const cfeExpiryDate = document.getElementById('cfeExpiryDate').value;
            const nifNumber = document.getElementById('nifNumber').value;

            // Données minimales pour un test
            const formData = new FormData();
            formData.append('first_name', 'Test');
            formData.append('last_name', 'User');
            formData.append('birth_date', '1990-01-01');
            formData.append('birth_place', 'Test City');
            formData.append('gender', 'M');
            formData.append('nationality', 'Test Nationality');
            formData.append('phone', '+22600000000');
            formData.append('merchant_phone', '+22600000001');
            formData.append('address', 'Test Address');
            formData.append('id_type', 'cni');
            formData.append('id_number', 'TEST123456');
            formData.append('id_expiry_date', '2030-12-31');
            formData.append('business_name', 'Test Business');
            formData.append('business_type', 'boutique');
            formData.append('business_address', 'Test Business Address');
            formData.append('usage_type', 'TRADER');
            formData.append('signature', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==');
            formData.append('accept_terms', 'true');
            
            // Ajouter les valeurs CFE/NIF selon les cases cochées
            formData.append('has_cfe', hasCFE);
            if (hasCFE) {
                if (cfeNumber) formData.append('cfe_number', cfeNumber);
                if (cfeExpiryDate) formData.append('cfe_expiry_date', cfeExpiryDate);
            }
            
            formData.append('has_nif', hasNIF);
            if (hasNIF && nifNumber) {
                formData.append('nif_number', nifNumber);
            }

            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'result info';
            resultsDiv.innerHTML = 'Test en cours...';

            try {
                const response = await axios.post('http://localhost:8000/api/merchant-applications', formData, {
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'multipart/form-data'
                    }
                });

                resultsDiv.className = 'result success';
                resultsDiv.innerHTML = `✅ VALIDATION BACKEND RÉUSSIE\n\nCode: ${response.status}\nRéférence: ${response.data.data?.reference_number || 'N/A'}\n\nConfiguration testée:\n- CFE activé: ${hasCFE}\n- NIF activé: ${hasNIF}\n\nValeurs envoyées:\n- CFE Number: "${cfeNumber}"\n- CFE Expiry: "${cfeExpiryDate}"\n- NIF Number: "${nifNumber}"\n\nLa candidature a été créée avec succès!`;

            } catch (error) {
                if (error.response?.status === 422) {
                    const validationErrors = error.response.data.errors;
                    let errorText = '';
                    for (const [field, messages] of Object.entries(validationErrors)) {
                        errorText += `${field}: ${messages.join(', ')}\n`;
                    }
                    
                    resultsDiv.className = 'result error';
                    resultsDiv.innerHTML = `❌ ERREURS DE VALIDATION BACKEND (422)\n\n${errorText}\n\nConfiguration testée:\n- CFE activé: ${hasCFE}\n- NIF activé: ${hasNIF}\n\nValeurs envoyées:\n- CFE Number: "${cfeNumber}"\n- CFE Expiry: "${cfeExpiryDate}"\n- NIF Number: "${nifNumber}"`;
                } else {
                    resultsDiv.className = 'result error';
                    resultsDiv.innerHTML = `❌ ERREUR BACKEND\n\nCode: ${error.response?.status || 'N/A'}\nMessage: ${error.message}\n\nDétails: ${JSON.stringify(error.response?.data, null, 2)}`;
                }
            }
        }

        function testScenario(scenario) {
            clearForm();
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const futureDate = tomorrow.toISOString().split('T')[0];
            
            switch(scenario) {
                case 'cfe-only':
                    document.getElementById('hasCFE').checked = true;
                    document.getElementById('cfeNumber').value = 'CFE123456';
                    document.getElementById('cfeExpiryDate').value = futureDate;
                    break;
                case 'nif-only':
                    document.getElementById('hasNIF').checked = true;
                    document.getElementById('nifNumber').value = 'NIF789012';
                    break;
                case 'both':
                    document.getElementById('hasCFE').checked = true;
                    document.getElementById('hasNIF').checked = true;
                    document.getElementById('cfeNumber').value = 'CFE123456';
                    document.getElementById('cfeExpiryDate').value = futureDate;
                    document.getElementById('nifNumber').value = 'NIF789012';
                    break;
                case 'neither':
                    // Ne rien cocher, laisser les champs vides
                    break;
            }
            
            updateRequiredFields();
            
            // Afficher la configuration
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'result info';
            resultsDiv.innerHTML = `📝 SCÉNARIO: ${scenario.toUpperCase()}\n\nConfiguration appliquée. Utilisez les boutons "Tester validation" pour valider.`;
        }

        function clearForm() {
            document.getElementById('hasCFE').checked = false;
            document.getElementById('hasNIF').checked = false;
            document.getElementById('cfeNumber').value = '';
            document.getElementById('cfeExpiryDate').value = '';
            document.getElementById('nifNumber').value = '';
            updateRequiredFields();
            document.getElementById('results').style.display = 'none';
        }

        // Initialisation
        updateRequiredFields();
    </script>
</body>
</html>